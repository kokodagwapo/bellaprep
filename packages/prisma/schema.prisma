// BellaPrep Multi-Tenant SaaS Database Schema
// PostgreSQL + Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// TENANT / LENDER
// ============================================

model Tenant {
  id             String   @id @default(cuid())
  name           String
  slug           String   @unique
  logo           String?
  primaryColor   String?  @default("#10B981")
  secondaryColor String?  @default("#059669")
  isActive       Boolean  @default(true)
  
  // Settings stored as JSON
  settings       Json     @default("{}")
  
  // Relations
  users          User[]
  products       LoanProduct[]
  formTemplates  FormTemplate[]
  loans          Loan[]
  auditLogs      AuditLog[]
  apiKeys        ApiKey[]
  qrCodes        QrCode[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([slug])
}

// ============================================
// USER & AUTHENTICATION
// ============================================

enum UserRole {
  SUPER_ADMIN
  LENDER_ADMIN
  LOAN_OFFICER
  PROCESSOR
  UNDERWRITER
  CLOSER
  BORROWER
}

model User {
  id             String    @id @default(cuid())
  email          String
  passwordHash   String
  firstName      String
  lastName       String
  phone          String?
  avatar         String?
  role           UserRole  @default(BORROWER)
  isActive       Boolean   @default(true)
  
  // MFA
  mfaEnabled     Boolean   @default(false)
  mfaSecret      String?   // TOTP secret (encrypted)
  mfaMethods     String[]  @default([])
  
  // WebAuthn credentials
  webauthnCredentials WebAuthnCredential[]
  
  // Tenant relation (null for SuperAdmin)
  tenantId       String?
  tenant         Tenant?   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Sessions
  sessions       Session[]
  refreshTokens  RefreshToken[]
  
  // Loans (borrower)
  borrowerLoans  Loan[]    @relation("BorrowerLoans")
  
  // Loans (staff assignments)
  loLoans        Loan[]    @relation("LOLoans")
  processorLoans Loan[]    @relation("ProcessorLoans")
  uwLoans        Loan[]    @relation("UWLoans")
  closerLoans    Loan[]    @relation("CloserLoans")
  
  // Audit
  auditLogs      AuditLog[]
  
  // Documents uploaded
  documentsUploaded LoanDocument[] @relation("UploadedBy")
  documentsVerified LoanDocument[] @relation("VerifiedBy")
  
  lastLogin      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([email, tenantId])
  @@index([tenantId])
  @@index([email])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  deviceInfo   String?
  ipAddress    String?
  userAgent    String?
  
  expiresAt    DateTime
  lastActive   DateTime @default(now())
  createdAt    DateTime @default(now())

  @@index([userId])
}

model RefreshToken {
  id           String   @id @default(cuid())
  token        String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  deviceInfo   String?
  ipAddress    String?
  
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model WebAuthnCredential {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  credentialId    String   @unique
  publicKey       String
  counter         Int      @default(0)
  deviceType      String?
  
  createdAt       DateTime @default(now())

  @@index([userId])
}

model MfaChallenge {
  id           String   @id @default(cuid())
  userId       String
  method       String   // SMS, EMAIL, TOTP
  code         String?  // Hashed OTP code
  
  expiresAt    DateTime
  verified     Boolean  @default(false)
  attempts     Int      @default(0)
  
  createdAt    DateTime @default(now())

  @@index([userId])
}

model PasswordReset {
  id           String   @id @default(cuid())
  email        String
  token        String   @unique
  
  expiresAt    DateTime
  usedAt       DateTime?
  
  createdAt    DateTime @default(now())

  @@index([email])
  @@index([token])
}

// ============================================
// LOAN PRODUCTS
// ============================================

enum LoanProductType {
  CONVENTIONAL
  FHA
  VA
  USDA
  JUMBO
  HELOC
  NON_QM
  MANUFACTURED
}

model LoanProduct {
  id               String          @id @default(cuid())
  tenantId         String
  tenant           Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name             String
  type             LoanProductType
  description      String?
  isActive         Boolean         @default(true)
  
  // Eligibility rules as JSON
  eligibility      Json            @default("{}")
  
  // Required fields for this product
  requiredFields   String[]        @default([])
  
  // Required documents
  requiredDocuments String[]       @default([])
  
  // Form template override
  formTemplateId   String?
  formTemplate     FormTemplate?   @relation(fields: [formTemplateId], references: [id])
  
  // Display order
  displayOrder     Int             @default(0)
  
  // Loans using this product
  loans            Loan[]
  
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([type])
}

// ============================================
// FORM BUILDER
// ============================================

enum FormType {
  PREP4LOAN
  URLA1003
  CUSTOM
}

model FormTemplate {
  id           String      @id @default(cuid())
  tenantId     String
  tenant       Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name         String
  type         FormType
  description  String?
  isDefault    Boolean     @default(false)
  isActive     Boolean     @default(true)
  
  // Sections
  sections     FormSection[]
  
  // Products using this template
  products     LoanProduct[]
  
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([tenantId])
  @@index([type])
}

model FormSection {
  id                    String       @id @default(cuid())
  templateId            String
  template              FormTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  name                  String
  description           String?
  displayOrder          Int          @default(0)
  isCollapsible         Boolean      @default(true)
  isCollapsedByDefault  Boolean      @default(false)
  
  // Visibility rules as JSON
  visibilityRules       Json         @default("[]")
  
  // Fields
  fields                FormField[]
  
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  @@index([templateId])
}

model FormField {
  id              String      @id @default(cuid())
  sectionId       String
  section         FormSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  
  key             String      // Unique field identifier
  label           String
  type            String      // TEXT, NUMBER, SELECT, etc.
  placeholder     String?
  helpText        String?
  displayOrder    Int         @default(0)
  
  // Validation
  required        Boolean     @default(false)
  validationRules Json        @default("[]")
  
  // Options for select fields
  options         Json        @default("[]")
  
  // Visibility rules
  visibilityRules Json        @default("[]")
  
  // Product-specific rules
  productRules    Json        @default("[]")
  
  // Layout width (FULL, HALF, THIRD, QUARTER)
  width           String      @default("FULL")
  
  // Mapping to loan data
  dataPath        String?
  
  // Auto-fill source
  autoFillSource  String?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@unique([sectionId, key])
  @@index([sectionId])
}

// ============================================
// LOANS
// ============================================

enum LoanStatus {
  DRAFT
  SUBMITTED
  IN_REVIEW
  PROCESSING
  UNDERWRITING
  CONDITIONALLY_APPROVED
  APPROVED
  DENIED
  WITHDRAWN
  CLOSED
}

enum LoanPurpose {
  PURCHASE
  REFINANCE
  CASH_OUT_REFINANCE
  CONSTRUCTION
  HOME_EQUITY
}

enum PropertyType {
  SINGLE_FAMILY
  CONDO
  TOWNHOUSE
  MULTI_FAMILY_2_4
  MANUFACTURED
  MOBILE_HOME
  CO_OP
}

enum OccupancyType {
  PRIMARY_RESIDENCE
  SECOND_HOME
  INVESTMENT
}

model Loan {
  id              String          @id @default(cuid())
  tenantId        String
  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Borrower
  borrowerId      String
  borrower        User            @relation("BorrowerLoans", fields: [borrowerId], references: [id])
  
  // Staff assignments
  loanOfficerId   String?
  loanOfficer     User?           @relation("LOLoans", fields: [loanOfficerId], references: [id])
  processorId     String?
  processor       User?           @relation("ProcessorLoans", fields: [processorId], references: [id])
  underwriterId   String?
  underwriter     User?           @relation("UWLoans", fields: [underwriterId], references: [id])
  closerId        String?
  closer          User?           @relation("CloserLoans", fields: [closerId], references: [id])
  
  // Product
  productId       String
  product         LoanProduct     @relation(fields: [productId], references: [id])
  productType     LoanProductType
  
  // Loan details
  purpose         LoanPurpose
  status          LoanStatus      @default(DRAFT)
  
  // Property
  propertyStreet  String?
  propertyUnit    String?
  propertyCity    String?
  propertyState   String?
  propertyZip     String?
  propertyCounty  String?
  propertyType    PropertyType?
  occupancyType   OccupancyType?
  propertyValue   Decimal?        @db.Decimal(12, 2)
  
  // Loan terms
  loanAmount      Decimal?        @db.Decimal(12, 2)
  downPayment     Decimal?        @db.Decimal(12, 2)
  interestRate    Decimal?        @db.Decimal(5, 3)
  term            Int?            // months
  
  // Form data (full JSON)
  formData        Json            @default("{}")
  
  // Documents
  documents       LoanDocument[]
  
  // Timeline
  timeline        LoanTimelineEvent[]
  
  // Conditions
  conditions      LoanCondition[]
  
  // Notes
  notes           LoanNote[]
  
  // Dates
  applicationDate DateTime        @default(now())
  submittedDate   DateTime?
  approvedDate    DateTime?
  closedDate      DateTime?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([tenantId])
  @@index([borrowerId])
  @@index([status])
  @@index([productId])
}

enum DocumentType {
  DRIVERS_LICENSE
  PASSPORT
  W2
  PAY_STUB
  TAX_RETURN
  BANK_STATEMENT
  ASSET_STATEMENT
  PURCHASE_CONTRACT
  APPRAISAL
  TITLE_REPORT
  INSURANCE
  OTHER
}

enum DocumentCategory {
  IDENTITY
  INCOME
  ASSETS
  PROPERTY
  LEGAL
  OTHER
}

model LoanDocument {
  id            String           @id @default(cuid())
  loanId        String
  loan          Loan             @relation(fields: [loanId], references: [id], onDelete: Cascade)
  
  name          String
  type          DocumentType
  category      DocumentCategory
  s3Key         String
  mimeType      String
  size          Int              // bytes
  
  // Upload info
  uploadedById  String
  uploadedBy    User             @relation("UploadedBy", fields: [uploadedById], references: [id])
  uploadedAt    DateTime         @default(now())
  
  // Verification
  verified      Boolean          @default(false)
  verifiedById  String?
  verifiedBy    User?            @relation("VerifiedBy", fields: [verifiedById], references: [id])
  verifiedAt    DateTime?
  
  // OCR extracted data
  ocrData       Json?
  
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@index([loanId])
  @@index([type])
}

enum TimelineEventType {
  CREATED
  SUBMITTED
  STATUS_CHANGED
  DOCUMENT_UPLOADED
  DOCUMENT_VERIFIED
  NOTE_ADDED
  ASSIGNED
  CONDITION_ADDED
  CONDITION_CLEARED
  COMMENT
}

model LoanTimelineEvent {
  id          String            @id @default(cuid())
  loanId      String
  loan        Loan              @relation(fields: [loanId], references: [id], onDelete: Cascade)
  
  type        TimelineEventType
  title       String
  description String?
  userId      String?
  metadata    Json?
  
  createdAt   DateTime          @default(now())

  @@index([loanId])
}

model LoanCondition {
  id          String   @id @default(cuid())
  loanId      String
  loan        Loan     @relation(fields: [loanId], references: [id], onDelete: Cascade)
  
  title       String
  description String?
  category    String?  // Prior to Docs, Prior to Funding, etc.
  
  isCleared   Boolean  @default(false)
  clearedById String?
  clearedAt   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([loanId])
}

model LoanNote {
  id        String   @id @default(cuid())
  loanId    String
  loan      Loan     @relation(fields: [loanId], references: [id], onDelete: Cascade)
  
  content   String
  authorId  String
  isPrivate Boolean  @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([loanId])
}

// ============================================
// INTEGRATIONS
// ============================================

model PlaidConnection {
  id              String   @id @default(cuid())
  loanId          String
  
  accessToken     String   // Encrypted
  itemId          String
  institutionId   String?
  institutionName String?
  
  // Linked accounts
  accounts        Json     @default("[]")
  
  // Last sync
  lastSyncAt      DateTime?
  syncError       String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([loanId])
}

model CalendarConnection {
  id              String   @id @default(cuid())
  userId          String
  
  provider        String   // google, microsoft
  accessToken     String   // Encrypted
  refreshToken    String?  // Encrypted
  
  calendarId      String?
  
  expiresAt       DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

model CalendarEvent {
  id              String   @id @default(cuid())
  connectionId    String
  
  externalId      String
  title           String
  description     String?
  
  startTime       DateTime
  endTime         DateTime
  
  loanId          String?
  attendees       Json     @default("[]")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([connectionId])
  @@index([loanId])
}

// ============================================
// QR CODES
// ============================================

enum QrCodeAction {
  LOGIN
  BORROWER_PORTAL
  DOCUMENT_UPLOAD
  LOAN_HANDOFF
  APPOINTMENT_CHECKIN
  FILE_ACCESS
}

model QrCode {
  id          String       @id @default(cuid())
  tenantId    String
  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  action      QrCodeAction
  token       String       @unique
  payload     Json         @default("{}")
  
  // Limits
  maxScans    Int?
  scanCount   Int          @default(0)
  
  expiresAt   DateTime
  
  // Scan logs
  scans       QrCodeScan[]
  
  createdAt   DateTime     @default(now())

  @@index([tenantId])
  @@index([token])
}

model QrCodeScan {
  id          String   @id @default(cuid())
  qrCodeId    String
  qrCode      QrCode   @relation(fields: [qrCodeId], references: [id], onDelete: Cascade)
  
  userId      String?
  ipAddress   String?
  userAgent   String?
  deviceInfo  String?
  
  success     Boolean  @default(true)
  error       String?
  
  scannedAt   DateTime @default(now())

  @@index([qrCodeId])
}

// ============================================
// AUDIT LOGS
// ============================================

enum AuditAction {
  // Auth
  LOGIN
  LOGOUT
  LOGIN_FAILED
  PASSWORD_CHANGED
  PASSWORD_RESET
  MFA_ENABLED
  MFA_DISABLED
  MFA_VERIFIED
  MFA_FAILED
  
  // User
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  USER_ACTIVATED
  USER_DEACTIVATED
  ROLE_CHANGED
  
  // Tenant
  TENANT_CREATED
  TENANT_UPDATED
  TENANT_SETTINGS_CHANGED
  
  // Loan
  LOAN_CREATED
  LOAN_UPDATED
  LOAN_SUBMITTED
  LOAN_STATUS_CHANGED
  LOAN_ASSIGNED
  LOAN_DELETED
  
  // Document
  DOCUMENT_UPLOADED
  DOCUMENT_VERIFIED
  DOCUMENT_DELETED
  DOCUMENT_DOWNLOADED
  
  // Product
  PRODUCT_CREATED
  PRODUCT_UPDATED
  PRODUCT_ACTIVATED
  PRODUCT_DEACTIVATED
  
  // Form
  FORM_TEMPLATE_CREATED
  FORM_TEMPLATE_UPDATED
  FORM_DATA_SAVED
  
  // Integration
  PLAID_CONNECTED
  PLAID_DISCONNECTED
  CALENDAR_CONNECTED
  CALENDAR_DISCONNECTED
  
  // QR
  QR_GENERATED
  QR_SCANNED
  
  // Settings
  SETTINGS_UPDATED
  INTEGRATION_CONFIGURED
  
  // Other
  EXPORT_GENERATED
  API_KEY_CREATED
  API_KEY_REVOKED
}

enum AuditResource {
  AUTH
  USER
  TENANT
  LOAN
  DOCUMENT
  PRODUCT
  FORM
  INTEGRATION
  QR
  SETTINGS
  API_KEY
}

model AuditLog {
  id            String        @id @default(cuid())
  tenantId      String
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  userId        String?
  user          User?         @relation(fields: [userId], references: [id])
  
  action        AuditAction
  resource      AuditResource
  resourceId    String?
  
  details       Json?
  previousValue Json?
  newValue      Json?
  
  ipAddress     String?
  userAgent     String?
  deviceInfo    String?
  
  createdAt     DateTime      @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
}

// ============================================
// API KEYS
// ============================================

model ApiKey {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name        String
  keyHash     String   @unique
  keyPrefix   String   // First 8 chars for identification
  
  // Permissions
  permissions String[] @default([])
  
  // Rate limiting
  rateLimit   Int      @default(1000) // requests per hour
  
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([keyHash])
}

// ============================================
// NOTIFICATIONS
// ============================================

enum NotificationType {
  EMAIL
  SMS
  PUSH
  IN_APP
}

model Notification {
  id          String           @id @default(cuid())
  userId      String
  
  type        NotificationType
  title       String
  message     String
  metadata    Json?
  
  read        Boolean          @default(false)
  readAt      DateTime?
  
  sentAt      DateTime?
  error       String?
  
  createdAt   DateTime         @default(now())

  @@index([userId])
  @@index([read])
}

model NotificationTemplate {
  id          String           @id @default(cuid())
  tenantId    String?
  
  key         String           @unique
  name        String
  type        NotificationType
  
  subject     String?          // For email
  body        String
  
  variables   String[]         @default([])
  
  isActive    Boolean          @default(true)
  
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([tenantId])
  @@index([key])
}

